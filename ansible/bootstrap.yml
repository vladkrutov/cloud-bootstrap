- name: Install Webmin, Docker Compose, and Jenkins
  hosts: localhost
  become: true

  vars:
    jenkins_port: 8080
    jenkins_container_name: jenkins

  tasks:
    - name: Add Webmin repository
      copy:
        dest: /etc/yum.repos.d/webmin.repo
        content: |
          [Webmin]
          name=Webmin
          baseurl=https://download.webmin.com/download/yum
          enabled=1
          gpgcheck=1
          gpgkey=https://download.webmin.com/jcameron-key.asc

    - name: Install Webmin
      dnf:
        name: webmin
        state: present

    - name: Open Webmin port in firewalld
      firewalld:
        port: 10000/tcp
        permanent: true
        state: enabled
        immediate: true

    - name: Enable and start Webmin
      systemd:
        name: webmin
        state: started
        enabled: true

    - name: Install Docker
      shell: |
        curl -fsSL https://get.docker.com | sh
      args:
        creates: /usr/bin/docker

    - name: Enable and start Docker
      systemd:
        name: docker
        state: started
        enabled: true

    - name: Install Docker Compose plugin
      get_url:
        url: https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64
        dest: /usr/local/bin/docker-compose
        mode: '0755'

    - name: Run Jenkins container
      shell: |
        docker run -d \
          --name {{ jenkins_container_name }} \
          -p {{ jenkins_port }}:8080 \
          -v jenkins_home:/var/jenkins_home \
          jenkins/jenkins:lts
      args:
        creates: /var/lib/docker/volumes/jenkins_home

    - name: Open Jenkins port in firewalld
      firewalld:
        port: "{{ jenkins_port }}/tcp"
        permanent: true
        state: enabled
        immediate: true
